#!/usr/bin/env node

const Kernel = require("../src/Shared/Infrastructure/Yion/Kernel");

const CreateUserCommand = require("../src/Admin/User/UI/Command/Create/Command");
const UploadImageCommand = require("../src/Admin/Image/UI/Command/Upload/Command");
const FormatImageCommand = require("../src/Admin/Image/UI/Command/Format/Command");
const CRUDCommand = require('./../src/Shared/UI/Maker/Command/CRUD');

const readline = require('readline');

const kernel = new Kernel();
const container = kernel.initServices();

const services = [
    container.get(CreateUserCommand),
    container.get(UploadImageCommand),
    container.get(FormatImageCommand),
    container.get(CRUDCommand),
];

const rl = readline.createInterface({
    input: process.stdin,
    output: process.stdout
});

const commands = {
    help: () => {
        const help = services.reduce((helpMessage, cmd) => {
            let args = '';
            let argsDescription = '';
            for (const argName in cmd.configuration.args) {
                const { type, description } = cmd.configuration.args[argName];

                args += `[${argName}] `;
                argsDescription += `    [${argName}] - <${type}> ${description}\n`
            }

            return helpMessage + `${cmd.name} ${args.trim()} - ${cmd.description}\n${argsDescription}\n`;
        }, '\nHelp :\n');

        console.log(help);
    },

    exit: () => {
        console.log('Exiting...');
        process.exit(0);
    },

    ...(services.reduce((cmds, cmd) => {
        cmds[cmd.name] = async (args) => await cmd.run(args);

        return cmds;
    }, {})),
};

console.log('Enter a command (help, exist)');

rl.on('line', async (input) => {
    const [command, ...args] = input.split(' ');
    if (commands[command]) {
        await commands[command](args);
    } else {
        console.log(`Invalid command: ${command}`);
        commands['help']();
    }
});
